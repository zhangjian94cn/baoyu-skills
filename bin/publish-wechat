#!/bin/bash
# ================================================================
# å¾®ä¿¡å…¬ä¼—å·å‘å¸ƒ â€” å¿«æ·å…¥å£
#
# ç”¨æ³•:
#   publish-wechat <article.md> [options]
#
# ç¤ºä¾‹:
#   publish-wechat ~/writing/my-article.md --cover ./cover.jpg
#   publish-wechat ~/writing/my-article.md --generate-cover
#   publish-wechat ~/writing/my-article.md --cover ./cover.jpg --dry-run
#
# æ–‡ç« å¯ä»¥åœ¨ä»»æ„ä½ç½®ï¼ˆå¦‚ Obsidian Vaultï¼‰ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨å®šä½
# baoyu-skills ä»“åº“å¹¶è°ƒç”¨ publish-wechat.ts workflowã€‚
# ================================================================

set -euo pipefail

# â”â”â” å®šä½è„šæœ¬å’Œä»“åº“ â”â”â”
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
WORKFLOW="$REPO_ROOT/workflows/publish-wechat.ts"

if [[ ! -f "$WORKFLOW" ]]; then
  echo "âŒ æ‰¾ä¸åˆ° workflow è„šæœ¬: $WORKFLOW"
  echo "   è¯·ç¡®è®¤ baoyu-skills ä»“åº“è·¯å¾„æ­£ç¡®"
  exit 1
fi

# â”â”â” æ£€æŸ¥å‚æ•° â”â”â”
if [[ $# -lt 1 || "$1" == "--help" || "$1" == "-h" ]]; then
  echo "å¾®ä¿¡å…¬ä¼—å·å‘å¸ƒ â€” å¿«æ·å…¥å£"
  echo ""
  echo "ç”¨æ³•: publish-wechat <article.md> [options]"
  echo ""
  echo "  æ–‡ç« è·¯å¾„æ”¯æŒ Obsidian Vault æˆ–ä»»æ„ç›®å½•ä¸­çš„ .md æ–‡ä»¶ã€‚"
  echo "  æ‰€æœ‰é€‰é¡¹ç›´æ¥é€ä¼ ç»™ publish-wechat.ts workflowã€‚"
  echo ""
  echo "å¸¸ç”¨é€‰é¡¹:"
  echo "  --cover <path>        æ‰‹åŠ¨æŒ‡å®šå°é¢å›¾"
  echo "  --generate-cover      AI ç”Ÿæˆå°é¢"
  echo "  --dry-run             é¢„è§ˆæ¨¡å¼"
  echo "  --title <title>       è¦†ç›– frontmatter æ ‡é¢˜"
  echo "  --author <author>     è¦†ç›–ä½œè€…"
  echo "  --summary <text>      è¦†ç›–æ‘˜è¦"
  echo "  --theme <theme>       ä¸»é¢˜: default | grace | simple"
  echo ""
  echo "ç¤ºä¾‹:"
  echo "  publish-wechat \"~/Nutstore Files/Obsidian Vault/0.writing/tech/my-article.md\" --cover cover.jpg"
  echo "  publish-wechat ./article.md --generate-cover --dry-run"
  exit 0
fi

# â”â”â” è§£ææ–‡ç« è·¯å¾„ â”â”â”
ARTICLE_PATH="$1"

# å±•å¼€ ~
ARTICLE_PATH="${ARTICLE_PATH/#\~/$HOME}"

if [[ ! -f "$ARTICLE_PATH" ]]; then
  echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: $ARTICLE_PATH"
  exit 1
fi

# è½¬ä¸ºç»å¯¹è·¯å¾„
ARTICLE_PATH="$(cd "$(dirname "$ARTICLE_PATH")" && pwd)/$(basename "$ARTICLE_PATH")"

echo "ğŸ“„ æ–‡ç« : $ARTICLE_PATH"
echo ""

# â”â”â” æ£€æŸ¥å°é¢ â”â”â”
# å¦‚æœ frontmatter ä¸­æŒ‡å®šäº† coverï¼Œä¸”æ²¡æœ‰ CLI --coverï¼Œå°è¯•è‡ªåŠ¨è¯»å–
HAS_COVER_ARG=false
for arg in "${@:2}"; do
  if [[ "$arg" == "--cover" || "$arg" == "--generate-cover" ]]; then
    HAS_COVER_ARG=true
    break
  fi
done

if [[ "$HAS_COVER_ARG" == false ]]; then
  # å°è¯•ä» frontmatter è¯»å– cover å­—æ®µ
  COVER=$(sed -n '/^---$/,/^---$/{ /^cover:/{s/^cover:[[:space:]]*["'"'"']*\([^"'"'"']*\)["'"'"']*/\1/p; }; }' "$ARTICLE_PATH")
  if [[ -n "$COVER" ]]; then
    # ç›¸å¯¹è·¯å¾„ â†’ ç›¸å¯¹æ–‡ç« æ‰€åœ¨ç›®å½•
    if [[ "$COVER" != /* && "$COVER" != http* ]]; then
      COVER="$(dirname "$ARTICLE_PATH")/$COVER"
    fi
    if [[ -f "$COVER" || "$COVER" == http* ]]; then
      echo "ğŸ–¼ï¸  Frontmatter å°é¢: $COVER"
      set -- "$@" "--cover" "$COVER"
    fi
  fi
fi

# â”â”â” æ‰§è¡Œå‘å¸ƒ â”â”â”
cd "$REPO_ROOT"
exec npx -y bun "$WORKFLOW" "$ARTICLE_PATH" "${@:2}"
